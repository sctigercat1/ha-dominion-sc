name: Release

"on":
  push:
    branches:
      - main
    paths:
      - custom_components/dominionsc/manifest.json
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  auto_tag:
    name: Tag release on manifest change
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/')

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Read version from manifest
        id: manifest
        run: |
          VERSION=$(python3 -c "import json; print(json.load(open('custom_components/dominionsc/manifest.json'))['version'])")

          if [ -z "$VERSION" ]; then
            echo "Version not found in manifest.json"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Manifest version: $VERSION"

      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG="v${{ steps.manifest.outputs.version }}"

          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists (local)"
            exit 0
          fi

          if git ls-remote --exit-code --tags origin "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists (remote)"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG does not exist"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          TAG="v${{ steps.manifest.outputs.version }}"
          echo "Creating tag $TAG"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Summary
        run: |
          TAG="v${{ steps.manifest.outputs.version }}"
          if [ "${{ steps.check_tag.outputs.exists }}" = "true" ]; then
            echo "Tag $TAG already existed. No new tag created." >> $GITHUB_STEP_SUMMARY
          else
            echo "Created and pushed tag $TAG from manifest.json version." >> $GITHUB_STEP_SUMMARY
            echo "Release workflow will trigger from the tag push." >> $GITHUB_STEP_SUMMARY
          fi

  release:
    name: Build and Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., v0.0.1 -> 0.0.1)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

          # Check if this is a pre-release
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: Verify manifest.json version matches tag
        run: |
          MANIFEST_VERSION=$(python3 -c "import json; print(json.load(open('custom_components/dominionsc/manifest.json'))['version'])")
          TAG_VERSION="${{ steps.version.outputs.version }}"

          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: manifest.json version ($MANIFEST_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

          echo "âœ… manifest.json version matches tag: $TAG_VERSION"

      - name: Build release package
        run: |
          echo "Building release package..."

          # Create build directory
          mkdir -p build

          # Create the integration package (zip file for HACS compatibility)
          PACKAGE_FILE="build/dominionsc-${{ steps.version.outputs.version }}.zip"

          # Package the custom_components directory
          cd custom_components
          zip -r "../$PACKAGE_FILE" dominionsc/ \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*" \
            -x "*.DS_Store"
          cd ..

          # Verify the package was created
          if [ ! -f "$PACKAGE_FILE" ]; then
            echo "ERROR: Package file not found: $PACKAGE_FILE"
            ls -la build/
            exit 1
          fi

          echo "âœ… Package created: $PACKAGE_FILE"
          ls -lh "$PACKAGE_FILE"

          # Show package contents
          echo ""
          echo "Package contents:"
          unzip -l "$PACKAGE_FILE" | head -20

      - name: Calculate SHA256 checksum
        id: checksum
        run: |
          PACKAGE_FILE="build/dominionsc-${{ steps.version.outputs.version }}.zip"

          # Calculate SHA256 checksum
          SHA256=$(sha256sum "$PACKAGE_FILE" | awk '{print $1}')

          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "âœ… SHA256 checksum: $SHA256"

          # Save checksum to file for release notes
          echo "$SHA256" > build/SHA256SUM

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if CHANGELOG.md exists
          if [ ! -f "CHANGELOG.md" ]; then
            echo "âš ï¸  CHANGELOG.md not found, using default release notes"
            NOTES="Release v$VERSION of the Dominion Energy SC Home Assistant integration."
          else
            # Extract release notes for this version from CHANGELOG.md
            # Look for the section between [VERSION] and the next version header

            if grep -q "\[$VERSION\]" CHANGELOG.md; then
              # Extract the section for this version
              NOTES=$(awk "/\[$VERSION\]/,/^## \[/" CHANGELOG.md | sed '1d;$d' | sed '/^$/d')

              if [ -z "$NOTES" ]; then
                echo "âš ï¸  No release notes found for version $VERSION in CHANGELOG.md"
                NOTES="See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
              else
                echo "âœ… Extracted release notes for version $VERSION"
              fi
            else
              echo "âš ï¸  Version $VERSION not found in CHANGELOG.md"
              NOTES="See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
            fi
          fi

          # Save to file (GitHub Actions doesn't handle multiline outputs well)
          echo "$NOTES" > build/RELEASE_NOTES.md

          # Add link to full changelog
          echo "" >> build/RELEASE_NOTES.md
          echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." >> build/RELEASE_NOTES.md

          # Add installation instructions
          echo "" >> build/RELEASE_NOTES.md
          echo "---" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md
          echo "## ðŸ“¦ Installation" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md
          echo "### Via HACS (Recommended)" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md
          echo "1. Open HACS in Home Assistant" >> build/RELEASE_NOTES.md
          echo "2. Go to **Integrations**" >> build/RELEASE_NOTES.md
          echo "3. Click the **â‹®** menu â†’ **Custom repositories**" >> build/RELEASE_NOTES.md
          echo "4. Add this repository: \`https://github.com/${{ github.repository }}\`" >> build/RELEASE_NOTES.md
          echo "5. Category: **Integration**" >> build/RELEASE_NOTES.md
          echo "6. Click **Add**" >> build/RELEASE_NOTES.md
          echo "7. Search for **Dominion Energy SC**" >> build/RELEASE_NOTES.md
          echo "8. Click **Download**" >> build/RELEASE_NOTES.md
          echo "9. Restart Home Assistant" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md
          echo "### Manual Installation" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md
          echo "1. Download \`dominionsc-$VERSION.zip\`" >> build/RELEASE_NOTES.md
          echo "2. Extract to \`config/custom_components/\`" >> build/RELEASE_NOTES.md
          echo "3. Restart Home Assistant" >> build/RELEASE_NOTES.md
          echo "4. Add the integration via **Settings** â†’ **Devices & Services** â†’ **Add Integration**" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md

          # Add SHA256 checksum to release notes
          echo "---" >> build/RELEASE_NOTES.md
          echo "" >> build/RELEASE_NOTES.md
          echo "**SHA256 Checksum:**" >> build/RELEASE_NOTES.md
          echo "\`\`\`" >> build/RELEASE_NOTES.md
          echo "${{ steps.checksum.outputs.sha256 }}  dominionsc-$VERSION.zip" >> build/RELEASE_NOTES.md
          echo "\`\`\`" >> build/RELEASE_NOTES.md

          cat build/RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body_path: build/RELEASE_NOTES.md
          files: |
            build/dominionsc-${{ steps.version.outputs.version }}.zip
            build/SHA256SUM
            CHANGELOG.md
          prerelease: ${{ steps.version.outputs.prerelease }}
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ v${{ steps.version.outputs.version }} Released Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** \`dominionsc-${{ steps.version.outputs.version }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256 Checksum:** \`${{ steps.checksum.outputs.sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version.outputs.prerelease }}" == "true" ]; then
            echo "**Type:** Pre-release" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Type:** Stable release" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Release created and package uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HACS users can now update to v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Manual installation package available for download" >> $GITHUB_STEP_SUMMARY

